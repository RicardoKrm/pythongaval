<!-- templates/flota/analisis_fallas.html -->
{% extends "flota/base.html" %}

{% block title %}Análisis de Fallas (Pareto){% endblock %}

{% block content %}
    <h1>Análisis de Fallas (Diagrama de Pareto)</h1>

    <div class="card">
        <h2>Gráfico de Pareto</h2>
        <p>Identifica las fallas más frecuentes que componen aproximadamente el 80% del total de los eventos.</p>
        <div class="chart-container">
            <canvas id="paretoChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>Tabla de Frecuencia de Fallas</h2>
        <table>
            <thead>
                <tr>
                    <th>Descripción de la Falla</th>
                    <th>Frecuencia (Cantidad)</th>
                    <th>Frecuencia Relativa (%)</th>
                    <th>Frecuencia Acumulada (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data_pareto_tabla %}
                <tr>
                    <td>{{ item.descripcion }}</td>
                    <td>{{ item.frecuencia }}</td>
                    <td>{{ item.frecuencia_relativa }}%</td>
                    <td>{{ item.frecuencia_acumulada }}%</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4">No hay órdenes de trabajo correctivas con tipos de falla asignados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Script JSON para los datos del gráfico -->
    <script id="chart-data" type="application/json">
    {
        "labels": {{ labels|safe }},
        "frecuenciaData": {{ frecuencia_data|safe }},
        "acumuladaData": {{ acumulada_data|safe }}
    }
    </script>

    <!-- Librería y código para el gráfico -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const dataElement = document.getElementById('chart-data');
        const chartData = JSON.parse(dataElement.textContent);

        const ctx = document.getElementById('paretoChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar', // Tipo de gráfico principal
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Frecuencia de Falla',
                        data: chartData.frecuenciaData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        yAxisID: 'y', // Asocia este dataset al eje Y izquierdo
                    },
                    {
                        label: 'Porcentaje Acumulado',
                        data: chartData.acumuladaData,
                        type: 'line', // Este dataset se dibuja como una línea
                        borderColor: '#ef4444',
                        backgroundColor: '#ef4444',
                        tension: 0.1,
                        yAxisID: 'y1', // Asocia este dataset al eje Y derecho
                    }
                ]
            },
            options: {
                scales: {
                    y: { // Eje Y izquierdo (Frecuencia)
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cantidad de Eventos'
                        }
                    },
                    y1: { // Eje Y derecho (Porcentaje)
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 0,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Porcentaje Acumulado (%)'
                        },
                        grid: {
                            drawOnChartArea: false, // No dibujar la grilla para este eje
                        },
                    }
                },
                maintainAspectRatio: false
            }
        });
    </script>
    <style>
        .chart-container {
            position: relative;
            height: 400px;
        }
    </style>
{% endblock %}