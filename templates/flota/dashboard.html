<!-- templates/flota/dashboard.html (Versión Final Combinada) -->
{% extends "flota/base.html" %}

{% block title %}Pizarra de Mantenimiento{% endblock %}

{% block content %}
    <h1>Pizarra de Mantenimiento Preventivo</h1>
    {% comment %}
Archivo: templates/flota/dashboard.html
Modificado para añadir columnas del Excel, respetando la estructura de `data_flota`.
{% endcomment %}

<table class="table table-bordered table-hover table-striped" id="pizarraMantenimientoTable">
    <thead>
        <tr>
            <!-- Columnas de trazabilidad del Excel -->
            <th>N° Int.</th>
            <th>PPU</th>
            <th>Marca</th>              <!-- NUEVA -->
            <th>Modelo</th>
            <th>Norma</th>              <!-- NUEVA -->
            <th>Intervalo KM</th>       <!-- NUEVA -->
            <th>KM Últ. Mant.</th>      <!-- NUEVA -->
            <th>Fecha Últ. Mant.</th>   <!-- NUEVA -->
            <th>Tipo Mant. Anterior</th><!-- NUEVA -->

            <!-- Columnas de estado del Excel -->
            <th>Estatus de la Mantención</th>
            <th>KM para Mantención</th>
            <th>Acum. Próx. Mant.</th>  <!-- NUEVA -->
            
            <!-- Columnas de pronóstico del Excel -->
            <th>KM Actual</th>
            <th>Fecha KM Actual</th>
            <th>KM Prox. Mant.</th>
            <th>Tipo Próx. Mant.</th>
            <th>Fecha Próx. Mant.</th>
            <th style="text-align: center;">Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for item in data_flota %}
            <!-- Usamos la clase de estado que ya tenías -->
            <tr class="estado-{{ item.estado }}">
                <!-- ======================= -->
                <!-- Datos de Trazabilidad -->
                <!-- ======================= -->
                <td><strong>{{ item.vehiculo.numero_interno }}</strong></td>
                <td>{{ item.vehiculo.ppu|default:"N/A" }}</td> <!-- Tu código original usa 'patente', lo cambio a 'ppu' para coincidir con tu modelo -->
                <td>{{ item.vehiculo.modelo.marca.nombre|default:"N/A" }}</td> <!-- NUEVA -->
                <td>{{ item.vehiculo.modelo.nombre|default:"N/A" }}</td> <!-- Tu código original usa item.vehiculo.modelo, lo ajusto -->
                <td>{{ item.vehiculo.norma_euro.nombre|default:"N/A" }}</td> <!-- NUEVA -->
                <td>{{ item.intervalo_km|floatformat:"0"|default:"--" }}</td> <!-- NUEVA -->
                <td>{{ item.km_ultimo_mant|floatformat:"0"|default:"--" }}</td> <!-- NUEVA -->
                <td>{{ item.fecha_ultimo_mant|date:"d/m/Y"|default:"--" }}</td> <!-- NUEVA -->
                <td>{{ item.tipo_ultimo_mant|default:"--" }}</td> <!-- NUEVA -->

                <!-- ======================= -->
                <!-- Datos de Estado -->
                <!-- ======================= -->
                <td><span class="status-pill status-{{ item.estado }}">{{ item.estado }}</span></td>
                <td>{{ item.kms_faltantes|floatformat:"0"|default:"--" }}</td> <!-- Reutilizo 'kms_faltantes' -->
                <td>{{ item.km_acum_prox|floatformat:"0"|default:"--" }}</td> <!-- NUEVA -->

                <!-- ======================= -->
                <!-- Datos de Pronóstico -->
                <!-- ======================= -->
                <td>{{ item.vehiculo.kilometraje_actual|floatformat:"0" }}</td>
                <td>{{ item.vehiculo.fecha_actualizacion_km|date:"d/m/Y H:i" }}</td>
                <td>{{ item.proximo_km|floatformat:"0"|default:"--" }}</td> <!-- Reutilizo 'proximo_km' -->
                <td>{{ item.proxima_pauta_obj.nombre|default:"--" }}</td> <!-- Reutilizo 'proxima_pauta_obj.nombre' -->
                <td>{{ item.fecha_prox_mant|date:"d M, Y"|default:"N/A" }}</td>
                <td class="actions-cell">
                    <!-- Tu menú de acciones se mantiene intacto -->
                    <button class="action-menu-btn" onclick="toggleMenu(event, 'menu-{{ item.vehiculo.pk }}')">⋮</button>
                    <div id="menu-{{ item.vehiculo.pk }}" class="action-menu">
                        <a href="#" onclick="openModal('{{ item.vehiculo.pk }}', '{{ item.vehiculo.numero_interno }}', '{{ item.vehiculo.kilometraje_actual }}')">Actualizar KM</a>
                        <a href="{% url 'historial_vehiculo' pk=item.vehiculo.pk %}">Ver Historial</a>
                        <a href="{% url 'analisis_km_vehiculo' pk=item.vehiculo.pk %}">Análisis de KM Diario</a>
                        <a href="{% url 'ot_list' %}?vehiculo_id={{ item.vehiculo.pk }}">Crear OT Correctiva</a>
                    </div>
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="18" style="text-align: center; padding: 20px;">No hay vehículos registrados para esta empresa.</td></tr>
        {% endfor %}
    </tbody>
</table>

    <!-- HTML del Modal para Actualizar KM (sin cambios) -->
    <div id="kmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">×</span>
            <h2>Actualizar Kilometraje</h2>
            <p>Vehículo N°: <strong id="modalVehiculoNumero"></strong></p>
            <form id="kmForm" method="post">
                {% csrf_token %}
                <label for="kilometraje_actual">Nuevo Kilometraje:</label>
                <input type="number" name="kilometraje_actual" id="modalKmInput" class="form-control" required>
                <button type="submit" class="btn-submit">Guardar</button>
            </form>
        </div>
    </div>

    <!-- JavaScript para manejar el Modal y los Menús Desplegables -->
    <script>
        const modal = document.getElementById('kmModal');
        const form = document.getElementById('kmForm');
        const vehiculoNumeroSpan = document.getElementById('modalVehiculoNumero');
        const kmInput = document.getElementById('modalKmInput');

        function openModal(vehiculoId, vehiculoNumero, kmActual) {
            event.stopPropagation();
            closeAllMenus();
            form.action = `/vehiculo/${vehiculoId}/actualizar-km/`;
            vehiculoNumeroSpan.textContent = vehiculoNumero;
            kmInput.value = kmActual;
            kmInput.placeholder = `KM actual: ${kmActual}`;
            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function toggleMenu(event, menuId) {
            event.stopPropagation();
            const currentMenu = document.getElementById(menuId);
            const isShown = currentMenu.classList.contains('show');
            closeAllMenus();
            if (!isShown) {
                currentMenu.classList.add('show');
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.action-menu').forEach(menu => menu.classList.remove('show'));
        }
        
        window.onclick = function(event) {
            closeAllMenus();
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
    
    <!-- Estilos CSS -->
    <style>
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #2d3748; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; position: relative; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: white; }
        
        .status-pill {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            min-width: 80px;
            text-align: center;
        }
        tr.estado-NORMAL .status-pill { background-color: #38a169; }
        tr.estado-PROXIMO .status-pill { background-color: #dd6b20; }
        tr.estado-VENCIDO .status-pill { background-color: #c53030; }

        .actions-cell { position: relative; text-align: center; }
        .action-menu-btn { background: none; border: none; color: #a0aec0; font-size: 1.5em; cursor: pointer; padding: 0 10px; border-radius: 4px; }
        .action-menu-btn:hover { background-color: #4a5568; color: white; }
        .action-menu {
            display: none;
            position: absolute;
            right: 20px;
            top: 40px;
            background-color: #4a5568;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
        }
        .action-menu a {
            color: #e2e8f0;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }
        .action-menu a:hover { background-color: #2d3748; }
        .action-menu.show { display: block; }
    </style>
{% endblock %}