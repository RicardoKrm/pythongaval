<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}TMS GAVAL{% endblock %} - {{ request.tenant.nombre }}</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <style>
        /* TUS ESTILOS ORIGINALES (SIN CAMBIOS) */
        body { font-family: system-ui, sans-serif; margin: 0; background-color: #1a202c; color: #cbd5e0; }
        nav { background-color: #2d3748; padding: 1em 2em; display: flex; justify-content: space-between; align-items: center; }
        .nav-links a { color: white; text-decoration: none; margin-right: 1.5em; font-weight: 500; }
        .nav-links a:hover { text-decoration: underline; }
        .user-menu { display: flex; align-items: center; gap: 1em; }
        .user-menu span { color: #a0aec0; }
        .user-menu a { color: white; text-decoration: none; }
        .btn-logout { background-color: #c53030; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: inherit; font-weight: 500; }
        .btn-logout:hover { background-color: #9b2c2c; }
        .container { padding: 2em; }
        .messages-container { padding: 0 2em; }
        .alert { padding: 15px; margin: 1em 0; border-radius: 4px; color: white; }
        .alert-success { background-color: #2f855a; }
        .alert-error { background-color: #c53030; }
        .alert-warning { background-color: #dd6b20; }
        .alert-info { background-color: #3182ce; }
        h1, h2 { color: #e2e8f0; border-bottom: 1px solid #4a5568; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; font-size: 0.9em; }
        th, td { padding: 12px; border: 1px solid #2d3748; text-align: left; }
        thead { background-color: #2d3748; color: #a0aec0; }
        .form-card { background-color: #2d3748; padding: 20px; border-radius: 8px; }
        form p { margin-bottom: 15px; }
        form label { display: block; margin-bottom: 5px; color: #a0aec0; }
        form input, form select, form textarea { width: 100%; padding: 10px; background-color: #1a202c; border: 1px solid #4a5568; color: white; border-radius: 4px; box-sizing: border-box; }
        .btn-submit { background-color: #38a169; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-submit:hover { background-color: #2f855a; }
        .card { background-color: #2d3748; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .btn-secondary { background-color: #4a5568; color: white; padding: 8px 12px; border-radius: 4px; text-decoration: none; }
        .btn-secondary:hover { background-color: #2d3748; }
        .mt-4 { margin-top: 1.5rem!important; }
        .status-ot-link { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; text-decoration: none; text-transform: uppercase; }
        .status-ot-link:hover { color: white; transform: scale(1.05); text-decoration: none; }
        .estado-ot-PENDIENTE { background-color: #dd6b20; }
        .estado-ot-EN_PROCESO { background-color: #3182ce; }
        .estado-ot-CERRADA_MECANICO { background-color: #718096; }

        /* ESTILOS AISLADOS PARA LA CAMPANA */
        .notification-bell-wrapper { position: relative; margin-right: 1.5em; }
        #notification-bell-button { background: none; border: none; color: white; cursor: pointer; padding: 5px; position: relative; }
        #notification-count { position: absolute; top: -5px; right: -8px; background-color: #c53030; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7em; font-weight: bold; border: 1px solid white; }
        #notification-popup { display: none; position: absolute; top: 40px; right: 0; width: 350px; max-height: 400px; overflow-y: auto; background-color: #2d3748; border: 1px solid #4a5568; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 1000; }
        #notification-popup a { display: block; padding: 12px 15px; color: #cbd5e0; text-decoration: none; border-bottom: 1px solid #4a5568; }
        #notification-popup a:hover { background-color: #4a5568; }
        #notification-popup a.notif-unread { background-color: #354154; font-weight: bold; }
        #notification-popup p { margin: 0; font-size: 0.9em; }
        #notification-popup .notif-time { font-size: 0.8em; color: #a0aec0; margin-top: 4px; }
        #notification-popup .notif-empty, #notification-popup .notif-footer { padding: 15px; text-align: center; color: #a0aec0; font-size: 0.9em; }
        #notification-popup .notif-footer a { border: none; padding: 0; display: inline; text-decoration: underline; }
    </style>
    
    {% block extra_head %}{% endblock %}

</head>
<body>
    <nav>
        <div class="nav-links">
            <a href="{% url 'dashboard' %}">Pizarra de Mantenimiento</a>
            <a href="{% url 'ot_list' %}">Órdenes de Trabajo</a>
            <a href="{% url 'pizarra_programacion' %}">Pizarra de Programación</a>
            <a href="{% url 'pizarra_combustible' %}">Control de Combustible</a>
            <a href="{% url 'repuesto_list' %}">Inventario</a>
            <a href="{% url 'indicadores_dashboard' %}">KPIs de Flota</a>
            <a href="{% url 'analisis_fallas' %}">Análisis de Fallas</a>
            <a href="{% url 'analisis_avanzado' %}">Costos y Tendencias</a>
            <a href="#">Reportes</a>
            {% if user.is_staff %}
                <a href="{% url 'carga_masiva' %}">Carga Masiva</a>
            {% endif %}

            <!-- ===== INICIO DEL CAMBIO CORREGIDO ===== -->
            {% if es_administrador %}
                <a href="{% url 'lista_usuarios' %}">Gestionar Usuarios</a>
            {% endif %}
            <!-- ===== FIN DEL CAMBIO CORREGIDO ===== -->
        </div>
        <div class="user-menu">
            {% if user.is_authenticated %}
                <div class="notification-bell-wrapper">
                    <button id="notification-bell-button">
                        <i class="fas fa-bell fa-lg"></i>
                        {% if notificaciones_no_leidas_count > 0 %}
                            <span id="notification-count">{{ notificaciones_no_leidas_count }}</span>
                        {% endif %}
                    </button>
                    <div id="notification-popup">
                        <div style="padding: 12px 15px; border-bottom: 1px solid #4a5568; font-weight: bold;">Notificaciones</div>
                        {% for notificacion in notificaciones_recientes %}
                            <a href="{{ notificacion.url_destino }}" class="{% if not notificacion.leida %}notif-unread{% endif %}">
                                <p>{{ notificacion.mensaje }}</p>
                                <div class="notif-time">{{ notificacion.fecha_creacion|timesince }} atrás</div>
                            </a>
                        {% empty %}
                            <div class="notif-empty">No tienes notificaciones nuevas.</div>
                        {% endfor %}
                        <div class="notif-footer"><a href="{% url 'lista_notificaciones' %}">Ver todas</a></div>
                    </div>
                </div>

                <span>Bienvenido, {{ user.username }}</span>
                <a href="#">Mi Perfil</a>
                <form action="{% url 'logout' %}" method="post" style="display: inline; margin: 0; padding: 0;">
                    {% csrf_token %}
                    <button type="submit" class="btn-logout">Cerrar Sesión</button>
                </form>
            {% endif %}
        </div>
    </nav>
    
    <div class="messages-container">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    </div>

    <div class="container">
        {% block content %}{% endblock %}
    </div>

    <!-- Librerías JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        $(document).ready(function() {
            $('.select2').select2();

            const bellButton = $('#notification-bell-button');
            const popup = $('#notification-popup');
            const countBadge = $('#notification-count');
            const markAsReadUrl = "{% url 'marcar_notificaciones_leidas' %}";
            const csrfToken = "{{ csrf_token }}";
            let notificationsHaveBeenMarked = false;

            if (bellButton.length > 0) {
                bellButton.on('click', function(event) {
                    event.stopPropagation();
                    popup.toggle();
                    
                    if (countBadge.is(':visible') && !notificationsHaveBeenMarked) {
                        notificationsHaveBeenMarked = true;
                        fetch(markAsReadUrl, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'ok') {
                                countBadge.hide();
                            } else {
                                notificationsHaveBeenMarked = false;
                            }
                        })
                        .catch(error => {
                            console.error("Error al marcar notificaciones como leídas:", error);
                            notificationsHaveBeenMarked = false;
                        });
                    }
                });

                $(document).on('click', function(event) {
                    if (!$(event.target).closest('.notification-bell-wrapper').length) {
                        if (popup.is(':visible')) {
                            popup.hide();
                        }
                    }
                });
            }
        });
    </script>
    
    {% block extra_scripts %}{% endblock extra_scripts %}
</body>
</html>