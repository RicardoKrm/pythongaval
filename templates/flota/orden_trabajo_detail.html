{% extends "flota/base.html" %}

{% block title %}Detalle OT {{ ot.folio|default:ot.pk }}{% endblock %}

{% block content %}
    <div style="margin-bottom: 1em;">
        <a href="{% url 'flota:ot_list' %}" class="btn-back">← Volver a la Lista de OTs</a>
    </div>

    <div class="header-container">
        <h1>Detalle de Orden de Trabajo #{{ ot.folio|default:ot.pk }}</h1>
        <a href="{% url 'flota:generar_ot_pdf' pk=ot.pk %}" target="_blank" class="btn-pdf">Generar PDF</a>
        <span class="status-badge status-{{ ot.estado|lower }}">{{ ot.get_estado_display }}</span>
    </div>

    {% if ot.estado == 'CERRADA_MECANICO' and ot.motivo_pendiente %}
        <div class="alert alert-warning">
            <strong>Atención Supervisor:</strong> El mecánico ha cerrado esta OT con el siguiente motivo:
            <p style="margin-top: 10px; font-style: italic;">"{{ ot.motivo_pendiente }}"</p>
        </div>
    {% endif %}

    <!-- Sección de Datos Generales -->
    <div class="card">
        <h2>Datos Generales</h2>
        <div class="grid-container">
            <div><strong>Vehículo:</strong> {{ ot.vehiculo }}</div>
            <div><strong>Tipo de OT:</strong> {{ ot.get_tipo_display }}</div>
            <div><strong>KM Apertura:</strong> {{ ot.kilometraje_apertura }} KM</div>
            <div><strong>Fecha Creación:</strong> {{ ot.fecha_creacion|date:"d/m/Y H:i" }}</div>
            <div><strong>Tipo de Falla:</strong> {{ ot.tipo_falla|default:"N/A" }}</div>
            <div><strong>Observación Inicial:</strong><br>{{ ot.observacion_inicial|default:"Ninguna." }}</div>
        </div>
        
        {% if es_admin_o_super %}
            <hr style="border-color: #4a5568; margin: 20px 0;">
            <form action="{% url 'flota:cambiar_estado_ot' pk=ot.pk %}" method="post" class="inline-form">
                {% csrf_token %}
                <p>
                    <label for="id_estado" style="flex-basis: auto; margin-right: 10px;">Cambiar Estado (Admin/Super):</label>
                    <select name="estado" id="id_estado" class="form-control" style="flex-grow: 1;">
                        {% for value, name in ot.ESTADO_CHOICES %}
                            {% if value != 'CERRADA_MECANICO' %}
                                <option value="{{ value }}" {% if ot.estado == value %}selected{% endif %}>{{ name }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn-submit" style="margin-left: 10px;">Actualizar Estado</button>
                </p>
            </form>
        {% endif %}
    </div>

    <!-- Tareas e Insumos (formularios y listas) -->
    <div class="card">
        <h2>Tareas Realizadas</h2>
        <form method="post" class="inline-form">
            {% csrf_token %}
            {{ tarea_form.as_p }}
            <button type="submit" name="add_tarea" class="btn-submit">Añadir Tarea</button>
        </form>
        <ul style="margin-top: 20px; padding-left: 20px;">
            {% for tarea in ot.tareas_realizadas.all %}
                <li>{{ tarea.descripcion }}</li>
            {% empty %}
                <li>No hay tareas asignadas a esta OT.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="card">
        <h2>Insumos Utilizados</h2>
        <form method="post" class="inline-form">
            {% csrf_token %}
            {{ insumo_form.as_p }}
            <button type="submit" name="add_insumo" class="btn-submit">Añadir Insumo</button>
        </form>
        <table style="margin-top: 20px;">
            <thead><tr><th>Insumo</th><th>Cantidad</th></tr></thead>
            <tbody>
                {% for detalle in ot.detalleinsumoot_set.all %}
                    <tr><td>{{ detalle.insumo.nombre }}</td><td>{{ detalle.cantidad }}</td></tr>
                {% empty %}
                    <tr><td colspan="2">No hay insumos registrados en esta OT.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Formulario de Cierre para el Mecánico -->
    {% if not es_admin_o_super and ot.estado != 'FINALIZADA' and ot.estado != 'CERRADA_MECANICO' %}
        <div class="card">
            <h2>Cierre de Trabajo (Mecánico)</h2>
            <p>Al finalizar tu trabajo, añade tareas e insumos y luego cierra la OT aquí. Si hay un problema que impida finalizar, explícalo en el motivo.</p>
            <form method="post">
                {% csrf_token %}
                {{ cerrar_mecanico_form.as_p }}
                <button type="submit" name="cerrar_mecanico" class="btn-submit">Marcar como Realizado por Mecánico</button>
            </form>
        </div>
    {% endif %}

    <style>
        .header-container { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .status-badge { padding: 5px 10px; border-radius: 12px; color: white; font-weight: bold; margin-left: auto; }
        .status-pendiente { background-color: #dd6b20; }
        .status-en_proceso { background-color: #3182ce; }
        .status-finalizada { background-color: #38a169; }
        .status-cerrada_mecanico { background-color: #805ad5; }
        .card { background-color: #2d3748; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .inline-form p { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .inline-form label { flex-shrink: 0; }
        .btn-pdf { background-color: #2b6cb0; color: white; padding: 8px 12px; text-decoration: none; border-radius: 4px; font-size: 0.9em; }
        .btn-pdf:hover { background-color: #2c5282; }
        .btn-back { display: inline-block; background-color: #4a5568; color: white; padding: 8px 12px; text-decoration: none; border-radius: 4px; font-size: 0.9em; margin-bottom: 1em; }
        .btn-back:hover { background-color: #718096; }
    </style>
{% endblock %}