{% extends "flota/base.html" %}

{% block title %}Detalle OT #{{ ot.folio }}{% endblock %}

{% block extra_head %}
<style>
.grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
@media (max-width: 992px) { .grid-container { grid-template-columns: 1fr; } }
.ot-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; }
.ot-status { padding: .25rem .75rem; border-radius: 9999px; font-weight: bold; color: white; }
.status-PENDIENTE { background-color: #dd6b20; }
.status-EN_PROCESO { background-color: #3182ce; }
.status-CERRADA_MECANICO { background-color: #718096; }
.status-FINALIZADA { background-color: #2f855a; }
.data-list { list-style: none; padding: 0; }
.data-list li { display: flex; justify-content: space-between; padding: .5rem 0; border-bottom: 1px solid #4a5568; }
.data-list li:last-child { border-bottom: none; }
.data-list strong { color: #a0aec0; }
.assigned-personnel-list li { padding: 0.5rem; border-radius: 4px; background-color: #1a202c; margin-bottom: 0.5rem; }
.assigned-personnel-list .badge-responsable { background-color: #f6ad55; color: #1a202c; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; font-weight: bold; margin-right: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="ot-header">
    <div>
        <h1>Orden de Trabajo <span class="text-muted">#{{ ot.folio }}</span></h1>
        <p class="h4">{{ ot.vehiculo }}</p>
    </div>
    <span class="ot-status status-{{ ot.estado }}">{{ ot.get_estado_display }}</span>
</div>

<div class="grid-container">
    <!-- Columna Izquierda: Información Principal, Tareas e Insumos -->
    <div class="left-column">
        <div class="card mb-4">
            <h4>Información General</h4>
            <ul class="data-list">
                <li><strong>Tipo:</strong> {{ ot.get_tipo_display }}</li>
                <li><strong>Formato:</strong> {{ ot.get_formato_display }}</li>
                <li><strong>Fecha Creación:</strong> {{ ot.fecha_creacion|date:"d M Y, H:i" }}</li>
                <li><strong>KM Apertura:</strong> {{ ot.kilometraje_apertura|floatformat:0 }}</li>
                <li><strong>KM Cierre:</strong> {{ ot.kilometraje_cierre|floatformat:0|default:"--" }}</li>
                <li><strong>Costo Total:</strong> ${{ ot.costo_total|floatformat:2 }}</li>
            </ul>
        </div>
        
        <div class="card mb-4">
            <h4><i class="fas fa-tasks mr-2"></i>Tareas Realizadas</h4>
            <!-- ... (Lógica para mostrar tareas) ... -->
        </div>

        <div class="card">
            <h4><i class="fas fa-boxes mr-2"></i>Insumos Utilizados</h4>
            <!-- ... (Lógica para mostrar insumos) ... -->
        </div>
    </div>

    <!-- Columna Derecha: Personal, Acciones y Formularios -->
    <div class="right-column">
        <!-- Panel de Personal Asignado -->
        <div class="card mb-4">
            <h4><i class="fas fa-users-cog mr-2"></i>Personal Asignado</h4>
            {% if ot.responsable or ot.personal_asignado.all %}
                <ul class="list-unstyled assigned-personnel-list">
                    {% if ot.responsable %}
                    <li><span class="badge-responsable">Responsable</span>{{ ot.responsable.username }}</li>
                    {% endif %}
                    {% for ayudante in ot.personal_asignado.all %}
                    <li>{{ ayudante.username }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No hay personal asignado a esta OT.</p>
            {% endif %}
        </div>
        
        <!-- Formularios de Acciones -->
        {% if es_admin_o_super %}
            <div class="card mb-4">
                <h4>Asignar Personal</h4>
                <form method="post">
                    {% csrf_token %}
                    {{ asignar_form.as_p }}
                    <button type="submit" name="asignar_personal" class="btn-submit mt-3">Guardar Asignación</button>
                </form>
            </div>
            
            <div class="card mb-4">
                <h4>Añadir Tarea</h4>
                <form method="post">
                    {% csrf_token %}
                    {{ tarea_form.as_p }}
                    <button type="submit" name="add_tarea" class="btn-submit mt-3">Añadir Tarea</button>
                </form>
            </div>

            <div class="card">
                <h4>Añadir Insumo</h4>
                <form method="post">
                    {% csrf_token %}
                    {{ insumo_form.as_p }}
                    <button type="submit" name="add_insumo" class="btn-submit mt-3">Añadir Insumo</button>
                </form>
            </div>
        {% endif %}

        <!-- Formulario para Mecánico -->
        <div class="card mt-4">
            <h4>Cerrar para Revisión</h4>
            <form method="post">
                {% csrf_token %}
                {{ cerrar_mecanico_form.as_p }}
                <button type="submit" name="cerrar_mecanico" class="btn-submit mt-3">Marcar como Realizado</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}