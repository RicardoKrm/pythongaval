{% extends "flota/base.html" %}

{% block title %}Detalle OT {{ ot.folio|default:ot.pk }}{% endblock %}

{% block content %}
    <div style="margin-bottom: 1em;">
        <a href="{% url 'ot_list' %}" class="btn-back">← Volver a la Lista de OTs</a>
    </div>

    <div class="header-container">
        <h1>Detalle de Orden de Trabajo #{{ ot.folio|default:ot.pk }}</h1>
        <a href="{% url 'generar_ot_pdf' pk=ot.pk %}" target="_blank" class="btn-pdf">Generar PDF</a>
        <span class="status-badge status-{{ ot.estado|lower }}">{{ ot.get_estado_display }}</span>
    </div>

    {% if ot.estado == 'CERRADA_MECANICO' and ot.motivo_pendiente %}
        <div class="alert alert-warning">
            <strong>Atención Supervisor:</strong> El mecánico ha cerrado esta OT con el siguiente motivo:
            <p style="margin-top: 10px; font-style: italic;">"{{ ot.motivo_pendiente }}"</p>
        </div>
    {% endif %}

    <div class="card">
        <h2>Datos Generales</h2>
        <div class="grid-container">
            <div><strong>Vehículo:</strong> {{ ot.vehiculo }}</div>
            <div><strong>Tipo de OT:</strong> {{ ot.get_tipo_display }}</div>
            <div><strong>KM Apertura:</strong> {{ ot.kilometraje_apertura }} KM</div>
            <div><strong>Fecha Creación:</strong> {{ ot.fecha_creacion|date:"d/m/Y H:i" }}</div>
            <div><strong>Tipo de Falla:</strong> {{ ot.tipo_falla|default:"N/A" }}</div>
            <div><strong>Observación Inicial:</strong><br>{{ ot.observacion_inicial|default:"Ninguna." }}</div>
        </div>
        
        {% if es_admin_o_super %}
            <hr style="border-color: #4a5568; margin: 20px 0;">
            <form action="{% url 'cambiar_estado_ot' pk=ot.pk %}" method="post" class="inline-form">
                {% csrf_token %}
                <p>
                    <label for="id_estado" style="flex-basis: auto; margin-right: 10px;">Cambiar Estado (Admin/Super):</label>
                    <select name="estado" id="id_estado" class="form-control" style="flex-grow: 1;">
                        {% for value, name in ot.ESTADO_CHOICES %}
                            {% if value != 'CERRADA_MECANICO' %}
                                <option value="{{ value }}" {% if ot.estado == value %}selected{% endif %}>{{ name }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn-submit" style="margin-left: 10px;">Actualizar</button>
                </p>
            </form>
        {% endif %}
    </div>

    <!-- ... (El resto del template con los formularios de Tareas e Insumos se mantiene igual) ... -->
{% endblock %}