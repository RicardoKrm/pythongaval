{% extends "flota/base.html" %}

{% block title %}Órdenes de Trabajo{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        :root { --dark-bg: #1C2431; --card-bg: #27303F; --input-bg: #343E4F; --accent-color: #4A90E2; --accent-color-dark: #3A7BCF; --text-primary: #E2E8F0; --text-secondary: #A0B0C4; --border-color: #3D4A5E; --header-gradient-start: #2A60B0; --header-gradient-end: #1E40AF; --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.25); --shadow-medium: 0 8px 20px rgba(0, 0, 0, 0.35); --success-color: #10B981; --warning-color: #F59E0B; --danger-color: #EF4444; --alert-danger-bg: rgba(239, 68, 68, 0.2); }
        body { background-color: var(--dark-bg) !important; color: var(--text-primary) !important; font-family: 'Inter', sans-serif; line-height: 1.6; padding-top: 2rem; padding-bottom: 2rem; }
        .container { max-width: 1200px; margin: 0 auto; padding-left: 1rem; padding-right: 1rem; }
        h1 { font-size: 2.8rem; font-weight: 700; color: var(--text-primary); margin-bottom: 2.5rem; text-align: center; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: var(--shadow-light); margin-bottom: 2.5rem; }
        .card-header { background-color: var(--input-bg); border-bottom: 1px solid var(--border-color); color: var(--text-primary); font-weight: 600; font-size: 1.4rem; padding: 1.25rem 2rem; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; display: flex; align-items: center; gap: 1rem; }
        .card-header h4 { margin-bottom: 0; color: var(--text-primary); }
        .card-header i { color: var(--accent-color); font-size: 1.6rem; }
        .card-body { padding: 2rem; }
        .table { color: var(--text-primary); margin-bottom: 0; }
        .table thead th { border-bottom: 2px solid var(--border-color); color: var(--text-secondary); font-weight: 600; padding: 1rem 0.75rem; }
        .table th, .table td { border-top: 1px solid var(--border-color); padding: 0.85rem 0.75rem; vertical-align: middle; }
        .table-hover tbody tr:hover { background-color: color-mix(in srgb, var(--card-bg) 80%, black); }
        .form-label { font-weight: 500; color: var(--text-secondary); margin-bottom: 0.6rem; font-size: 0.95em; }
        .form-control, .form-select { background-color: var(--input-bg); color: var(--text-primary); border-color: var(--border-color); padding: 0.75rem 1.2rem; border-radius: 0.5rem; font-size: 1rem; }
        .form-control:focus, .form-select:focus { background-color: var(--input-bg); color: var(--text-primary); border-color: var(--accent-color); box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, 0.3); }
        .ot-status { padding: .4rem 1rem; border-radius: 9999px; font-weight: 700; color: white; font-size: 0.85em; box-shadow: 0 2px 6px rgba(0,0,0,0.2); display: inline-block; min-width: 100px; text-align: center; }
        .status-PENDIENTE { background-color: var(--warning-color); }
        .status-EN_PROCESO { background-color: var(--accent-color); }
        .status-PAUSADA { background-color: #D69E2E; }
        .status-CERRADA_MECANICO { background-color: var(--text-secondary); }
        .status-FINALIZADA { background-color: var(--success-color); }
        .alert-danger { background-color: var(--alert-danger-bg); border-color: var(--danger-color); color: var(--danger-color); padding: 1.25rem 1.75rem; border-radius: 0.75rem; margin-bottom: 1.5rem; }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    {% if es_mecanico %}
        <h1 class="mb-4">Mis Órdenes de Trabajo Asignadas</h1>
    {% else %}
        <h1 class="mb-4">Órdenes de Trabajo</h1>
    {% endif %}
    
    {% if es_personal_operativo %}
    <div id="crear-ot-seccion" class="card mb-5">
        <div class="card-header">
            <h4><i class="fas fa-plus-circle me-2"></i> Crear Nueva Orden de Trabajo</h4>
        </div>
        <div class="card-body">
            <form method="post" id="form-crear-ot" novalidate>
                {% csrf_token %}
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <strong>Por favor, corrija los siguientes errores:</strong>
                        <ul class="mb-0 mt-2">
                            {% for field in form %}{% if field.errors %}{% for error in field.errors %}<li><strong>{{ field.label }}:</strong> {{ error }}</li>{% endfor %}{% endif %}{% endfor %}
                            {{ form.non_field_errors }}
                        </ul>
                    </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-6 mb-3"><label for="{{ form.vehiculo.id_for_label }}" class="form-label">{{ form.vehiculo.label }}</label>{{ form.vehiculo }}</div>
                    <div class="col-md-6 mb-3"><label for="{{ form.kilometraje_apertura.id_for_label }}" class="form-label">{{ form.kilometraje_apertura.label }}</label>{{ form.kilometraje_apertura }}</div>
                    <div class="col-md-4 mb-3"><label for="{{ form.tipo.id_for_label }}" class="form-label">{{ form.tipo.label }}</label>{{ form.tipo }}</div>
                    <div class="col-md-4 mb-3"><label for="{{ form.formato.id_for_label }}" class="form-label">{{ form.formato.label }}</label>{{ form.formato }}</div>
                    <div class="col-md-4 mb-3"><label for="{{ form.prioridad.id_for_label }}" class="form-label">{{ form.prioridad.label }}</label>{{ form.prioridad }}</div>
                    <div class="col-md-4 mb-3"><label for="{{ form.fecha_programada.id_for_label }}" class="form-label">{{ form.fecha_programada.label }}</label>{{ form.fecha_programada }}</div>
                </div>
                <div class="form-group mb-3" id="campo-pauta_mantenimiento" style="display: none;"><label for="{{ form.pauta_mantenimiento.id_for_label }}" class="form-label">{{ form.pauta_mantenimiento.label }}</label>{{ form.pauta_mantenimiento }}</div>
                <div class="form-group mb-3" id="campo-tipo_falla" style="display: none;"><label for="{{ form.tipo_falla.id_for_label }}" class="form-label">{{ form.tipo_falla.label }}</label>{{ form.tipo_falla }}</div>
                <div class="form-group mb-3" id="campo-sintomas_reportados" style="display: none;"><label for="{{ form.sintomas_reportados.id_for_label }}" class="form-label">{{ form.sintomas_reportados.label }}</label>{{ form.sintomas_reportados }}</div>
                <div class="form-group mb-3"><label for="{{ form.observacion_inicial.id_for_label }}" class="form-label">{{ form.observacion_inicial.label }}</label>{{ form.observacion_inicial }}</div>
                <button type="submit" class="btn btn-success mt-3"><i class="fas fa-save me-2"></i>Crear OT</button>
            </form>
        </div>
    </div>
    {% endif %}
    
    <div class="card">
        <div class="card-header">
            <h4><i class="fas fa-filter me-2"></i> Filtros y Listado de OTs</h4>
        </div>
        <div class="card-body">
            <form method="get" class="mb-4 p-3 rounded" style="background-color: var(--dark-bg);">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3"><div class="form-group"><label for="{{ filtro_form.vehiculo.id_for_label }}">{{ filtro_form.vehiculo.label }}</label>{{ filtro_form.vehiculo }}</div></div>
                    <div class="col-md"><div class="form-group"><label for="{{ filtro_form.tipo.id_for_label }}">{{ filtro_form.tipo.label }}</label>{{ filtro_form.tipo }}</div></div>
                    <div class="col-md"><div class="form-group"><label for="{{ filtro_form.estado.id_for_label }}">{{ filtro_form.estado.label }}</label>{{ filtro_form.estado }}</div></div>
                    <div class="col-md"><div class="form-group"><label for="{{ filtro_form.fecha_desde.id_for_label }}">{{ filtro_form.fecha_desde.label }}</label>{{ filtro_form.fecha_desde }}</div></div>
                    <div class="col-md"><div class="form-group"><label for="{{ filtro_form.fecha_hasta.id_for_label }}">{{ filtro_form.fecha_hasta.label }}</label>{{ filtro_form.fecha_hasta }}</div></div>
                    <div class="col-md-auto d-grid"><button type="submit" class="btn btn-primary">Filtrar</button></div>
                </div>
            </form>
            <hr style="border-color: var(--border-color);">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead><tr><th>Folio</th><th>Vehículo</th><th>Tipo</th><th>Estado</th><th>Fecha Creación</th><th>Acciones</th></tr></thead>
                    <tbody>
                        {% for ot in ordenes %}
                        <tr>
                            <td>{{ ot.folio }}</td>
                            <td>{{ ot.vehiculo.numero_interno }} - {{ ot.vehiculo.patente }}</td>
                            <td>{{ ot.get_tipo_display }}</td>
                            <td><span class="ot-status status-{{ ot.estado }}">{{ ot.get_estado_display }}</span></td>
                            <td>{{ ot.fecha_creacion|date:"d/m/Y H:i" }}</td>
                            <td><a href="{% url 'ot_detail' pk=ot.pk %}" class="btn btn-sm btn-info"><i class="fas fa-eye"></i></a></td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center">No se encontraron órdenes de trabajo.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <nav aria-label="Paginación" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if ordenes.has_previous %}<li class="page-item"><a class="page-link" href="?page=1&{{ request.GET.urlencode | cut:'page=' }}">« Primera</a></li><li class="page-item"><a class="page-link" href="?page={{ ordenes.previous_page_number }}&{{ request.GET.urlencode | cut:'page=' }}">Anterior</a></li>{% endif %}
                    <li class="page-item active" aria-current="page"><span class="page-link">Página {{ ordenes.number }} de {{ ordenes.paginator.num_pages }}</span></li>
                    {% if ordenes.has_next %}<li class="page-item"><a class="page-link" href="?page={{ ordenes.next_page_number }}&{{ request.GET.urlencode | cut:'page=' }}">Siguiente</a></li><li class="page-item"><a class="page-link" href="?page={{ ordenes.paginator.num_pages }}&{{ request.GET.urlencode | cut:'page=' }}">Última »</a></li>{% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.select2').select2({
                theme: "bootstrap-5",
            });
            const tipoSelect = $('#id_tipo');
            const pautaField = $('#campo-pauta_mantenimiento');
            const tipoFallaField = $('#campo-tipo_falla');
            const sintomasField = $('#campo-sintomas_reportados');
            function toggleFields() {
                const tipo = tipoSelect.val();
                pautaField.hide();
                tipoFallaField.hide();
                sintomasField.hide();
                if (tipo === 'PREVENTIVA') {
                    pautaField.show();
                } else if (tipo === 'CORRECTIVA') {
                    tipoFallaField.show();
                } else if (tipo === 'EVALUATIVA') {
                    tipoFallaField.show();
                    sintomasField.show();
                }
            }
            tipoSelect.on('change', toggleFields);
            toggleFields();
        });
    </script>
{% endblock extra_scripts %}