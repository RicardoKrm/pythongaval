{% extends "flota/base.html" %}

{% block title %}Órdenes de Trabajo{% endblock %}

{% block extra_head %}
    <!-- Tus estilos CSS (sin cambios) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a202c !important; color: #cbd5e0 !important; }
        .card { background-color: #2d3748; border: 1px solid #4a5568; }
        .table { color: #cbd5e0; }
        .table thead th { border-bottom: 2px solid #4a5568; }
        .table th, .table td { border-top: 1px solid #4a5568; }
        .table-hover tbody tr:hover { background-color: #3d485c; }
        .form-label { font-weight: bold; }
        .form-control, .form-select { background-color: #1a202c; color: #cbd5e0; border-color: #4a5568; }
        .form-control:focus, .form-select:focus { background-color: #2d3748; color: #cbd5e0; border-color: #3182ce; box-shadow: none; }
        .select2-container--default .select2-selection--single { background-color: #1a202c !important; border: 1px solid #4a5568 !important; height: calc(1.5em + .75rem + 2px) !important; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { color: #cbd5e0 !important; line-height: calc(1.5em + .75rem) !important; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: calc(1.5em + .75rem) !important; }
        .ot-status { padding: .25rem .75rem; border-radius: 9999px; font-weight: bold; color: white; font-size: 0.8em; }
        .status-PENDIENTE { background-color: #dd6b20; }
        .status-EN_PROCESO { background-color: #3182ce; }
        .status-PAUSADA { background-color: #d69e2e; }
        .status-CERRADA_MECANICO { background-color: #718096; }
        .status-FINALIZADA { background-color: #2f855a; }
        .errorlist { color: #f56565; margin: 5px 0 0 0; padding: 0; list-style-type: none; font-size: 0.9em; font-weight: bold; }
        .pagination .page-link { background-color: #2d3748; border-color: #4a5568; color: #cbd5e0; }
        .pagination .page-item.active .page-link { background-color: #3182ce; border-color: #3182ce; }
        .pagination .page-item.disabled .page-link { background-color: #1a202c; border-color: #4a5568; color: #718096; }
    </style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Órdenes de Trabajo</h1>

<div id="crear-ot-seccion" class="card mb-5">
    <div class="card-header">
        <h4><i class="fas fa-plus-circle me-2"></i> Crear Nueva Orden de Trabajo</h4>
    </div>
    <div class="card-body">
        <form method="post" id="form-crear-ot" novalidate>
            {% csrf_token %}
            {% if form.errors %}
                <div class="alert alert-danger" style="background-color: #c53030;">
                    <strong>Por favor, corrija los siguientes errores:</strong>
                    {{ form.non_field_errors }}
                    <ul class="mb-0 mt-2">
                        {% for field in form %}{% for error in field.errors %}<li><strong>{{ field.label }}:</strong> {{ error }}</li>{% endfor %}{% endfor %}
                    </ul>
                </div>
            {% endif %}

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.vehiculo.id_for_label }}" class="form-label">{{ form.vehiculo.label }}</label>
                    {{ form.vehiculo }}
                    <div class="text-danger small mt-1">{{ form.vehiculo.errors|striptags }}</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.kilometraje_apertura.id_for_label }}" class="form-label">{{ form.kilometraje_apertura.label }}</label>
                    {{ form.kilometraje_apertura }}
                    <div class="text-danger small mt-1">{{ form.kilometraje_apertura.errors|striptags }}</div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.tipo.id_for_label }}" class="form-label">{{ form.tipo.label }}</label>
                    {{ form.tipo }}
                    <div class="text-danger small mt-1">{{ form.tipo.errors|striptags }}</div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.formato.id_for_label }}" class="form-label">{{ form.formato.label }}</label>
                    {{ form.formato }}
                    <div class="text-danger small mt-1">{{ form.formato.errors|striptags }}</div>
                </div>
                
                <!-- ================== BLOQUE AÑADIDO (PRIORIDAD) ================== -->
                <div class="col-md-4 mb-3">
                    <label for="{{ form.prioridad.id_for_label }}" class="form-label">{{ form.prioridad.label }}</label>
                    {{ form.prioridad }}
                    <div class="text-danger small mt-1">{{ form.prioridad.errors|striptags }}</div>
                </div>
                <!-- ============================================================== -->
            </div>

            <!-- ================== CAMPO AÑADIDO (FECHA PROGRAMADA) ================== -->
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.fecha_programada.id_for_label }}" class="form-label">{{ form.fecha_programada.label }}</label>
                    {{ form.fecha_programada }}
                    <div class="text-danger small mt-1">{{ form.fecha_programada.errors|striptags }}</div>
                </div>
            </div>
            <!-- ==================================================================== -->

            <div class="form-group mb-3" id="campo-pauta_mantenimiento" style="display: none;">
                <label for="{{ form.pauta_mantenimiento.id_for_label }}" class="form-label">{{ form.pauta_mantenimiento.label }}</label>
                {{ form.pauta_mantenimiento }}
                <div class="text-danger small mt-1">{{ form.pauta_mantenimiento.errors|striptags }}</div>
            </div>
            <div class="form-group mb-3" id="campo-tipo_falla" style="display: none;">
                <label for="{{ form.tipo_falla.id_for_label }}" class="form-label">{{ form.tipo_falla.label }}</label>
                {{ form.tipo_falla }}
                <div class="text-danger small mt-1">{{ form.tipo_falla.errors|striptags }}</div>
            </div>
            <div class="form-group mb-3" id="campo-sintomas_reportados" style="display: none;">
                <label for="{{ form.sintomas_reportados.id_for_label }}" class="form-label">{{ form.sintomas_reportados.label }}</label>
                {{ form.sintomas_reportados }}
                <div class="text-danger small mt-1">{{ form.sintomas_reportados.errors|striptags }}</div>
            </div>
            
            <div class="form-group mb-3">
                <label for="{{ form.observacion_inicial.id_for_label }}" class="form-label">{{ form.observacion_inicial.label }}</label>
                {{ form.observacion_inicial }}
                <div class="text-danger small mt-1">{{ form.observacion_inicial.errors|striptags }}</div>
            </div>
            
            <button type="submit" class="btn btn-success mt-3"><i class="fas fa-save me-2"></i>Crear OT</button>
        </form>
    </div>
</div>

<!-- Listado y filtros (sin cambios) -->
<div class="card">
    <div class="card-header">
        <h4><i class="fas fa-filter me-2"></i> Filtros y Listado de OTs</h4>
    </div>
    <div class="card-body">
        <form method="get" class="mb-4 p-3 rounded" style="background-color: #1a202c;">
            <div class="row g-3 align-items-end">
                <div class="col-md-3"><div class="form-group">{{ filtro_form.vehiculo.label_tag }}{{ filtro_form.vehiculo }}</div></div>
                <div class="col-md"><div class="form-group">{{ filtro_form.tipo.label_tag }}{{ filtro_form.tipo }}</div></div>
                <div class="col-md"><div class="form-group">{{ filtro_form.estado.label_tag }}{{ filtro_form.estado }}</div></div>
                <div class="col-md"><div class="form-group">{{ filtro_form.fecha_desde.label_tag }}{{ filtro_form.fecha_desde }}</div></div>
                <div class="col-md"><div class="form-group">{{ filtro_form.fecha_hasta.label_tag }}{{ filtro_form.fecha_hasta }}</div></div>
                <div class="col-md-auto d-grid"><button type="submit" class="btn btn-primary">Filtrar</button></div>
            </div>
        </form>
        <hr>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead><tr><th>Folio</th><th>Vehículo</th><th>Tipo</th><th>Estado</th><th>Fecha Creación</th><th>Acciones</th></tr></thead>
                <tbody>
                    {% for ot in ordenes %}
                    <tr>
                        <td>{{ ot.folio }}</td>
                        <td>{{ ot.vehiculo.numero_interno }} - {{ ot.vehiculo.patente }}</td>
                        <td>{{ ot.get_tipo_display }}</td>
                        <td><span class="ot-status status-{{ ot.estado }}">{{ ot.get_estado_display }}</span></td>
                        <td>{{ ot.fecha_creacion|date:"d/m/Y H:i" }}</td>
                        <td><a href="{% url 'ot_detail' pk=ot.pk %}" class="btn btn-sm btn-info"><i class="fas fa-eye"></i></a></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="text-center">No se encontraron órdenes de trabajo con los filtros aplicados.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <nav aria-label="Paginación" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if ordenes.has_previous %}<li class="page-item"><a class="page-link" href="?page=1&{{ request.GET.urlencode | cut:'page=' }}">« Primera</a></li><li class="page-item"><a class="page-link" href="?page={{ ordenes.previous_page_number }}&{{ request.GET.urlencode | cut:'page=' }}">Anterior</a></li>{% endif %}
                <li class="page-item active" aria-current="page"><span class="page-link">Página {{ ordenes.number }} de {{ ordenes.paginator.num_pages }}</span></li>
                {% if ordenes.has_next %}<li class="page-item"><a class="page-link" href="?page={{ ordenes.next_page_number }}&{{ request.GET.urlencode | cut:'page=' }}">Siguiente</a></li><li class="page-item"><a class="page-link" href="?page={{ ordenes.paginator.num_pages }}&{{ request.GET.urlencode | cut:'page=' }}">Última »</a></li>{% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <!-- Tu script de jQuery que ya funcionaba (sin cambios) -->
    <script>
        $(document).ready(function() {
            const tipoSelect = $('#id_tipo');
            const pautaField = $('#campo-pauta_mantenimiento');
            const tipoFallaField = $('#campo-tipo_falla');
            const sintomasField = $('#campo-sintomas_reportados');

            function toggleFields() {
                const tipo = tipoSelect.val();
                pautaField.hide();
                tipoFallaField.hide();
                sintomasField.hide();
                if (tipo === 'PREVENTIVA') pautaField.show();
                else if (tipo === 'CORRECTIVA') tipoFallaField.show();
                else if (tipo === 'EVALUATIVA') {
                    tipoFallaField.show();
                    sintomasField.show();
                }
            }
            tipoSelect.on('change', toggleFields);
            toggleFields();
        });
    </script>
{% endblock extra_scripts %}