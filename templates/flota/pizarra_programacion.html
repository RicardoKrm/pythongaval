{% extends "flota/base.html" %}

{% block title %}Pizarra de Programación{% endblock %}

{% block extra_head %}
    <!-- CSS de FullCalendar -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />

    <!-- CSS de Bootstrap 5 (para estilizar los componentes) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Estilos personalizados para el tema oscuro y el calendario -->
    <style>
        html, body { 
            background-color: #1a202c !important; 
            color: #cbd5e0 !important;
        }

        .card { background-color: #2d3748; border: 1px solid #4a5568; }
        .form-label { font-weight: bold; }
        .form-control, .form-select { background-color: #1a202c; color: #cbd5e0; border-color: #4a5568; }
        .form-control:focus, .form-select:focus { background-color: #2d3748; border-color: #3182ce; box-shadow: none; color: #cbd5e0;}
        .select2-container--default .select2-selection--single { background-color: #1a202c !important; border: 1px solid #4a5568 !important; height: calc(1.5em + .75rem + 2px) !important; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { color: #cbd5e0 !important; line-height: calc(1.5em + .75rem) !important; }
        
        #calendar { max-width: 100%; margin: 0 auto; }
        .fc-daygrid-day-number, .fc-col-header-cell-cushion { color: #a0aec0; text-decoration: none; }
        .fc-day-today { background: #2d3748 !important; }
        .fc-button { background-color: #3182ce !important; border-color: #3182ce !important; box-shadow: none !important; }
        .fc-toolbar-title { color: #e2e8f0; }
        .fc-event { cursor: grab; }
        .fc-event:active { cursor: grabbing; }

        /* Colores de fondo por ESTADO */
        .fc-event.estado-PENDIENTE { background-color: #dd6b20; border-color: #dd6b20; }
        .fc-event.estado-EN_PROCESO { background-color: #3182ce; border-color: #3182ce; }
        .fc-event.estado-PAUSADA { background-color: #d69e2e; border-color: #d69e2e; }
        .fc-event.estado-CERRADA_MECANICO { background-color: #718096; border-color: #718096; }
        .fc-event.estado-FINALIZADA { background-color: #2f855a; border-color: #2f855a; }
        
        /* Estilos de borde por PRIORIDAD */
        .fc-event {
            border-left: 5px solid transparent; /* Borde por defecto */
        }
        .fc-event.prioridad-BAJA {
            border-left-color: #3182ce; /* Azul */
        }
        .fc-event.prioridad-MEDIA {
            border-left-color: #718096; /* Gris */
        }
        .fc-event.prioridad-ALTA {
            border-left-color: #dd6b20; /* Naranja */
        }
        .fc-event.prioridad-CRITICA {
            border-left-color: #c53030; /* Rojo */
        }

        /* --- NUEVOS ESTILOS PARA LOS ICONOS DE DISPONIBILIDAD --- */
        .fc-event-main-frame { /* Asegura que este estilo se aplica para flexbox */
            display: flex;
            align-items: center;
            gap: 5px; /* Espacio entre el texto del evento y el icono */
            height: 100%; /* Asegura que el contenedor flex ocupe todo el espacio del evento */
        }
        .fc-event-title-wrap { 
            flex-grow: 1; /* Permite que el título ocupe el espacio restante */
            overflow: hidden; /* Evita que el título se desborde si es muy largo */
            text-overflow: ellipsis; /* Añade puntos suspensivos si el texto es muy largo */
            white-space: nowrap; /* Mantiene el texto en una sola línea */
        }
        .repuesto-icon { 
            width: 18px; /* Ajusta el tamaño del icono */
            height: 18px;
            flex-shrink: 0; /* Evita que el icono se comprima */
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }
        .repuesto-icon.disponible {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="green"><path d="M0 0h24v24H0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'); 
        }
        .repuesto-icon.faltante {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/></svg>');
        }
    </style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Pizarra de Programación</h1>

<!-- Formulario de Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" id="filtro-calendario-form" class="row g-3 align-items-end">
            <div class="col-md-3"> {# Ajustado de col-md-4 para dar espacio al nuevo filtro #}
                <label for="{{ filtro_form.vehiculo.id_for_label }}" class="form-label">{{ filtro_form.vehiculo.label }}</label>
                {{ filtro_form.vehiculo }}
            </div>
            <div class="col-md-3">
                <label for="{{ filtro_form.estado.id_for_label }}" class="form-label">{{ filtro_form.estado.label }}</label>
                {{ filtro_form.estado }}
            </div>
            <div class="col-md-3"> {# Ajustado de col-md-4 para dar espacio al nuevo filtro #}
                <label for="{{ filtro_form.responsable.id_for_label }}" class="form-label">{{ filtro_form.responsable.label }}</label>
                {{ filtro_form.responsable }}
            </div>
            <!-- ¡NUEVO FILTRO DE DISPONIBILIDAD DE REPUESTOS AÑADIDO AQUÍ! -->
            <div class="col-md-3">
                <label for="{{ filtro_form.repuestos_disponibles.id_for_label }}" class="form-label">{{ filtro_form.repuestos_disponibles.label }}</label>
                {{ filtro_form.repuestos_disponibles }}
            </div>
            <div class="col-12 mt-3">
                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                <a href="{% url 'pizarra_programacion' %}" class="btn btn-secondary">Limpiar Filtros</a>
            </div>
        </form>
    </div>
</div>

<!-- Contenedor del Calendario -->
<div class="card p-4">
    <div id='calendar'></div>
</div>
{% endblock %}

{% block extra_scripts %}
    <!-- JS de FullCalendar y sus plugins GRATUITOS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@5.11.3/main.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@5.11.3/main.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@5.11.3/main.global.min.js'></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var filtroForm = document.getElementById('filtro-calendario-form'); 
        
        // Define el patrón de URL para actualizar la OT.
        const UPDATE_OT_URL_PATTERN = "{% url 'actualizar_fecha_ot_api' pk=0 %}"; // '0' es un placeholder

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek', 
            locale: 'es',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay,dayGridMonth'
            },
            editable: true,
            
            // ¡Plugins: MANTENEMOS TU CONFIGURACIÓN ORIGINAL Y FUNCIONAL!
            // Si tenías un array 'plugins: []' vacío, podrías ponerlo.
            // Si no lo tenías, dejarlo así es lo más seguro.
            
            // Clic en un día para crear OT
            dateClick: function(info) {
                const fechaSeleccionada = info.dateStr.split('T')[0];
                const url = `{% url 'ot_list' %}?fecha_programada=${fechaSeleccionada}&from_calendar=true`;
                window.location.href = url;
            },
            
            // Asigna clases CSS a los eventos según su estado y prioridad (TU FUNCIÓN ORIGINAL)
            eventClassNames: function(arg) {
                let classes = []; 

                // Clase para el ESTADO
                if (arg.event.extendedProps.estado) {
                    classes.push('estado-' + arg.event.extendedProps.estado.replace(/ /g, '_').toUpperCase());
                }

                // Clase para la PRIORIDAD - Asumiendo que prioridad viene en extendedProps, como lo enviaría la API
                if (arg.event.extendedProps.prioridad) { 
                    classes.push('prioridad-' + arg.event.extendedProps.prioridad.toUpperCase());
                }
                
                return classes;
            },

            // Función para cargar eventos desde la API de Django (MODIFICADA LIGERAMENTE para añadir filtro)
            events: function(fetchInfo, successCallback, failureCallback) {
                const params = new URLSearchParams(new FormData(filtroForm)); 
                
                params.append('start', fetchInfo.startStr);
                params.append('end', fetchInfo.endStr);

                const url = `{% url 'ot_eventos_api' %}?${params.toString()}`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => successCallback(data))
                    .catch(error => {
                        console.error('Error al cargar eventos:', error);
                        failureCallback(error);
                    });
            },
            
            // Maneja el arrastre y soltado de eventos para actualizar su fecha programada (TU FUNCIÓN ORIGINAL)
            // Se mantiene como la tenías, sin la promesa ni eventAllow, para respetar tu base funcional.
            eventDrop: function(info) {
                const otId = info.event.id;
                const nuevaFecha = info.event.start.toISOString(); // Tu código original
                const csrfToken = '{{ csrf_token }}';

                fetch(`/api/ot-actualizar-fecha/${otId}/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify({ fecha_programada: nuevaFecha })
                })
                .then(response => {
                    if (!response.ok) { info.revert(); alert('Error al reprogramar la OT.'); return Promise.reject('Respuesta no OK'); }
                    return response.json();
                })
                .then(data => {
                    if (data.status !== 'ok') { info.revert(); alert('Error: ' + data.message); }
                })
                .catch(error => { 
                    if (error !== 'Respuesta no OK') { info.revert(); alert('Ocurrió un error de conexión.'); }
                });
            },

            // --- ¡NUEVO!: Customización del contenido del evento para añadir el icono de disponibilidad ---
            // Esta función se encarga de cómo se ve el contenido interno de cada evento.
            eventContent: function(arg) {
                let eventContentEl = document.createElement('div');
                eventContentEl.classList.add('fc-event-main-frame'); 
                
                let titleEl = document.createElement('div');
                titleEl.classList.add('fc-event-title-wrap'); 
                titleEl.innerText = arg.event.title;
                eventContentEl.appendChild(titleEl);

                // Añade el icono de disponibilidad de repuestos solo si la información está presente
                // (es decir, si la API 'ot_eventos_api' la ha enviado)
                if (arg.event.extendedProps && typeof arg.event.extendedProps.hasAllPartsAvailable !== 'undefined') {
                    let iconEl = document.createElement('div');
                    iconEl.classList.add('repuesto-icon');
                    if (arg.event.extendedProps.hasAllPartsAvailable) {
                        iconEl.classList.add('disponible');
                        iconEl.title = 'Repuestos disponibles';
                    } else {
                        iconEl.classList.add('faltante');
                        iconEl.title = 'Faltan repuestos';
                    }
                    eventContentEl.appendChild(iconEl);
                }
                
                return { domNodes: [eventContentEl] }; // Retorna el elemento customizado
            },

            // Adjunta el tooltip a cada evento una vez que ha sido montado en el DOM (MODIFICADA para añadir disponibilidad)
            eventDidMount: function(info) {
                // Se añade la información de disponibilidad de repuestos al tooltip
                let repuestosStatus = 'No especificado';
                if (info.event.extendedProps && typeof info.event.extendedProps.hasAllPartsAvailable !== 'undefined') {
                    repuestosStatus = info.event.extendedProps.hasAllPartsAvailable ? 'Disponibles' : 'Faltan';
                }

                new bootstrap.Tooltip(info.el, {
                    title: `<b>Vehículo:</b> ${info.event.title}<br><b>Tipo:</b> ${info.event.extendedProps.tipo}<br><b>Estado:</b> ${info.event.extendedProps.estado}<br><b>Responsable:</b> ${info.event.extendedProps.responsable || 'N/A'}<br><b>Prioridad:</b> ${info.event.extendedProps.prioridad || 'N/A'}<br><b>Repuestos:</b> ${repuestosStatus}`,
                    html: true, placement: 'top', trigger: 'hover', container: 'body'
                });
            },
            
            // Al hacer clic en un evento (OT), redirige a su página de detalle (TU FUNCIÓN ORIGINAL)
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                if (info.event.url) { window.open(info.event.url, "_blank"); }
            }
        });

        calendar.render();

        document.getElementById('filtro-calendario-form').addEventListener('change', function() {
            calendar.refetchEvents();
        });
    });
    </script>
{% endblock extra_scripts %}