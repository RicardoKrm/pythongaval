{% extends "flota/base.html" %}

{% block title %}Pizarra de Programación{% endblock %}

{% comment %} Bloqueamos el ancho completo en base.html para esta página si prefieres el sidebar fijo,
si quieres que el calendario se extienda por completo, puedes ponerlo en "true" como en el dashboard. {% endcomment %}
{% block full_width_content %}false{% endblock %}

{% block extra_head %}
    <!-- FullCalendar CSS (aún necesario, luego lo sobreescribimos) -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    
    <style>
        /* Estilos personalizados para FullCalendar y elementos específicos */

        /* CONTENEDOR PRINCIPAL: Usamos flexbox para layout de 2 columnas */
        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 8rem); /* Ajusta si tu nav/footer cambian la altura */
            gap: 1.5rem;
            padding: 1.5rem 0; /* Padding vertical, aumentado */
        }
        @media (max-width: 992px) { /* Tabletas y móviles */
            .dashboard-container { flex-direction: column; padding: 1rem; }
            .sidebar { width: 100%; flex-direction: row; flex-wrap: wrap; gap: 1rem; }
            .sidebar .card { flex: 1 1 calc(50% - 0.5rem); } /* Dos columnas en el sidebar */
            .ot-panel { height: auto; min-height: 250px; }
            #calendar { height: 650px; }
        }
        @media (max-width: 768px) { /* Móviles más pequeños */
            .sidebar .card { flex: 1 1 100%; } /* Una columna en el sidebar */
            #calendar { height: 500px; }
        }

        /* SIDEBAR */
        .sidebar {
            width: 350px; /* Ancho fijo para el sidebar en pantallas grandes */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* PANEL DE OTS PENDIENTES */
        .ot-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .ot-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: grid;
            gap: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        /* ÍTEM DE OT INDIVIDUAL */
        .ot-item {
            background-color: var(--bg-secondary); /* Usa el color secundario del tema */
            border-left: 5px solid var(--accent); /* Borde izquierdo con color de acento */
            border-radius: 0.6rem;
            padding: 1.2rem;
            cursor: grab;
            transition: all 0.25s ease;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Sombra ligera */
        }
        .ot-item:active { cursor: grabbing; }
        .ot-item:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.3); }

        .ot-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .ot-item-title { font-weight: 600; font-size: 1.05rem; margin: 0; color: var(--text-primary); }
        .ot-item-priority {
            font-size: 0.7rem; padding: 0.3rem 0.6rem; border-radius: 0.3rem;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
            min-width: 60px; text-align: center;
        }
        /* Colores de prioridad (basados en tu paleta Pulser) */
        .priority-CRITICA { background-color: #EF4444; color: white; } /* red-500 */
        .priority-ALTA { background-color: #F59E0B; color: #1A202C; } /* amber-500 */
        .priority-MEDIA { background-color: #64748B; color: white; } /* slate-500 */
        .priority-BAJA { background-color: var(--accent); color: white; } /* tu color accent */

        .ot-item-details { display: flex; flex-wrap: wrap; gap: 0.75rem 1.5rem; font-size: 0.85rem; color: var(--text-secondary); }
        .ot-item-detail { display: flex; align-items: center; gap: 0.5rem; }
        .ot-item-detail i { width: 18px; text-align: center; color: var(--accent); } /* Iconos con color de acento */

        /* FULLCALENDAR OVERRIDES (Sobreescribiendo estilos de FullCalendar) */
        #calendar {
            background-color: var(--card-base-bg); /* Usa el color de tarjeta de tu tema */
            border-radius: 0.75rem;
            padding: 1rem;
            height: 750px; /* Altura fija para el calendario */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Encabezado de la barra de herramientas de FullCalendar */
        .fc-toolbar-title { font-weight: 600; color: var(--text-primary); font-size: 1.4rem; }
        .fc-toolbar { flex-wrap: wrap; } /* Permite que los elementos se envuelvan */
        .fc-toolbar-chunk { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; } /* Espaciado y ajuste */
        .fc-toolbar .fc-button-group { display: flex; flex-wrap: wrap; }
        
        /* Celdas de encabezado (días de la semana) */
        .fc-col-header-cell { background-color: var(--bg-secondary); border-bottom: 1px solid var(--input-border); }
        .fc-col-header-cell-cushion { color: var(--text-primary); padding: 0.75rem; font-size: 1rem; font-weight: 600; }
        
        /* Números de día y celdas de cuadrícula */
        .fc-daygrid-day-number { color: var(--text-secondary); padding: 0.5rem; font-size: 0.9rem; font-weight: 500; }
        .fc-daygrid-day { background-color: var(--card-base-bg); border: 1px solid var(--input-border); }
        .fc-day-today { background-color: hsla(195, 90%, 65%, 0.15) !important; border: 1px solid var(--accent) !important; }
        
        /* Botones de FullCalendar */
        .fc-button {
            background-color: var(--input-bg) !important; border: none !important;
            padding: 0.5rem 1rem !important; font-size: 0.95rem !important;
            border-radius: 0.4rem !important; color: var(--text-primary) !important;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .fc-button:hover { background-color: var(--input-border) !important; transform: translateY(-1px); }
        .fc-button-active { background-color: var(--accent) !important; color: white !important; box-shadow: 0 2px 4px hsla(195, 90%, 65%, 0.2); }
        
        /* Eventos en el calendario */
        .fc-event {
            border: none !important; font-weight: 500; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            font-size: 0.85rem; cursor: pointer; border-radius: 0.3rem; margin-bottom: 2px;
            color: white; /* Asegura texto blanco para eventos */
        }
        /* Colores de fondo por ESTADO (usando clases de Tailwind o variables) */
        .fc-event.estado-PENDIENTE { background-color: #F59E0B; } /* amber-500 */
        .fc-event.estado-EN_PROCESO { background-color: #3B82F6; } /* blue-500 */
        .fc-event.estado-PAUSADA { background-color: #F97316; } /* orange-500 */
        .fc-event.estado-CERRADA_MECANICO { background-color: #64748B; } /* slate-500 */
        .fc-event.estado-FINALIZADA { background-color: #10B981; } /* emerald-500 */
        
        /* Estilos de borde por PRIORIDAD (igual que antes) */
        .fc-event { border-left: 5px solid transparent !important; }
        .fc-event.prioridad-BAJA { border-left-color: var(--accent) !important; }
        .fc-event.prioridad-MEDIA { border-left-color: #64748B !important; }
        .fc-event.prioridad-ALTA { border-left-color: #F59E0B !important; }
        .fc-event.prioridad-CRITICA { border-left-color: #EF4444 !important; }
        
        .fc-event-main-frame { display: flex; align-items: center; gap: 6px; height: 100%; padding: 0.3rem 0.5rem; width: 100%; box-sizing: border-box; }
        .fc-event-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; min-width: 0; }
        .repuesto-icon { font-size: 0.9rem; flex-shrink: 0; }
        
        /* Área de drop */
        .fc-highlight { background: hsla(195, 90%, 65%, 0.2) !important; opacity: 0.7; }
        .dragged-ot { opacity: 0.7; transform: scale(1.02); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); z-index: 1000; }
        
        /* Tooltip de FullCalendar (Bootstrap) */
        .tooltip-inner {
            background-color: var(--card-base-bg); /* Fondo del tooltip */
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 0.875rem;
        }
        .tooltip.bs-tooltip-auto[x-placement^=top] .tooltip-arrow::before,
        .tooltip.bs-tooltip-top .tooltip-arrow::before { border-top-color: var(--card-base-bg); }
        .tooltip.bs-tooltip-auto[x-placement^=right] .tooltip-arrow::before,
        .tooltip.bs-tooltip-right .tooltip-arrow::before { border-right-color: var(--card-base-bg); }
        .tooltip.bs-tooltip-auto[x-placement^=bottom] .tooltip-arrow::before,
        .tooltip.bs-tooltip-bottom .tooltip-arrow::before { border-bottom-color: var(--card-base-bg); }
        .tooltip.bs-tooltip-auto[x-placement^=left] .tooltip-arrow::before,
        .tooltip.bs-tooltip-left .tooltip-arrow::before { border-left-color: var(--card-base-bg); }
    </style>
{% endblock %}

{% block content %}
<div class="max-w-full px-4 sm:px-6 lg:px-8"> {# Usamos el full_width_content de base.html pero con padding explícito #}
    <div class="dashboard-container">
        <!-- Panel lateral para OT nuevas -->
        <aside class="sidebar">
            <div class="card-style ot-panel"> {# Usamos nuestra clase card-style #}
                <div class="px-6 py-4 border-b border-input-border bg-bg-secondary flex items-center gap-3 rounded-t-lg"> {# Header de tarjeta custom #}
                    <i class="fas fa-plus-circle text-accent"></i>
                    <h5 class="text-lg font-semibold text-text-primary">Órdenes de Trabajo Pendientes</h5>
                </div>
                <div class="p-0 flex-grow"> {# body p-0 #}
                    <div class="ot-list" id="ot-pendientes">
                        {% for ot_item in ot_pendientes %} {# Asumiendo que pasas ot_pendientes del contexto #}
                        <div class="ot-item" draggable="true" 
                             data-ot-id="{{ ot_item.id }}" 
                             data-ot-title="{{ ot_item.titulo_evento }}" 
                             data-ot-duration="{{ ot_item.duracion_horas|default:2 }}" {# Asume una duración por defecto si no está #}
                             data-ot-priority="{{ ot_item.prioridad }}" 
                             data-ot-estado="{{ ot_item.estado }}" 
                             data-ot-vehiculo="{{ ot_item.vehiculo.numero_interno }} ({{ ot_item.vehiculo.patente }})" 
                             data-ot-responsable="{{ ot_item.responsable.username|default:'N/A' }}">
                            <div class="ot-item-header">
                                <h5 class="ot-item-title">{{ ot_item.titulo_evento }}</h5>
                                <span class="ot-item-priority priority-{{ ot_item.prioridad|upper }}">{{ ot_item.prioridad|upper }}</span>
                            </div>
                            <div class="ot-item-details">
                                <div class="ot-item-detail">
                                    <i class="fas fa-car"></i>
                                    <span>{{ ot_item.vehiculo.numero_interno }}</span>
                                </div>
                                <div class="ot-item-detail">
                                    <i class="fas fa-clock"></i>
                                    <span>{{ ot_item.duracion_horas|default:2 }}h</span>
                                </div>
                                <div class="ot-item-detail">
                                    <i class="fas fa-user-tie"></i>
                                    <span>{{ ot_item.responsable.username|default:'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-sm text-text-secondary italic text-center p-4">No hay órdenes de trabajo pendientes.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Filtros en versión compacta para el sidebar -->
            <div class="card-style"> {# Usamos nuestra clase card-style #}
                <div class="px-6 py-4 border-b border-input-border bg-bg-secondary flex items-center gap-3 rounded-t-lg"> {# Header de tarjeta custom #}
                    <i class="fas fa-sliders-h text-accent"></i>
                    <h5 class="text-lg font-semibold text-text-primary">Filtros</h5>
                </div>
                <div class="p-6"> {# Card body #}
                    <form method="get" id="filtro-calendario-form" class="space-y-4"> {# Usamos space-y-4 para gap vertical #}
                        <div>
                            <label for="{{ filtro_form.vehiculo.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-1">{{ filtro_form.vehiculo.label }}</label>
                            {{ filtro_form.vehiculo }}
                        </div>
                        <div>
                            <label for="{{ filtro_form.estado.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-1">{{ filtro_form.estado.label }}</label>
                            {{ filtro_form.estado }}
                        </div>
                        <div>
                            <label for="{{ filtro_form.responsable.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-1">{{ filtro_form.responsable.label }}</label>
                            {{ filtro_form.responsable }}
                        </div>
                        <div>
                            <label for="{{ filtro_form.repuestos_disponibles.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-1">{{ filtro_form.repuestos_disponibles.label }}</label>
                            {{ filtro_form.repuestos_disponibles }}
                        </div>
                        <div class="flex flex-wrap justify-end gap-3 pt-2"> {# Ajuste de margen y justificación #}
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-filter"></i> Aplicar
                            </button>
                            <a href="{% url 'pizarra_programacion' %}" class="inline-flex items-center justify-center px-4 py-2 border border-input-border text-sm font-medium rounded-md shadow-sm text-text-secondary bg-bg-secondary hover:bg-input-border transition-transform duration-200 hover:scale-105">
                                <i class="fas fa-broom"></i> Limpiar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </aside>
        
        <!-- Contenido principal -->
        <main class="main-content flex-grow">
            <div class="bg-[var(--accent)] bg-opacity-20 backdrop-blur-sm p-8 rounded-lg shadow-xl text-white mb-6 relative overflow-hidden"> {# dashboard-header #}
                <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-blue-400/10 to-transparent pointer-events-none rounded-lg"></div>
                <h1 class="text-3xl font-bold mb-2 flex items-center gap-3 text-text-primary">
                    <i class="fas fa-calendar-alt"></i>Pizarra de Programación
                </h1>
                <p class="text-lg text-text-secondary">
                    Arrastra las OT desde el panel izquierdo al calendario para asignarlas
                </p>
            </div>

            <div class="card-style"> {# Usamos nuestra clase card-style #}
                <div class="px-6 py-4 border-b border-input-border bg-bg-secondary flex items-center gap-3 rounded-t-lg"> {# Header de tarjeta custom #}
                    <i class="fas fa-calendar-days text-accent"></i>
                    <h5 class="text-lg font-semibold text-text-primary">Programación de Órdenes de Trabajo</h5>
                </div>
                <div class="p-0"> {# body p-0 #}
                    <div id='calendar'></div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    {{ block.super }} {# Incluye scripts de base.html #}
    
    <!-- JS de FullCalendar y sus plugins -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@5.11.3/main.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@5.11.3/main.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@5.11.3/main.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>

    <!-- Bootstrap Bundle JS (SOLO PARA TOOLTIPS DE FULLCALENDAR) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Define las URLs de Django en variables JavaScript
        const otEventsApiUrl = "{% url 'ot_eventos_api' %}";
        const otUpdateDateUrl = "/api/ot-actualizar-fecha/"; // URL base para la actualización de fecha

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var filtroForm = document.getElementById('filtro-calendario-form');
            var otList = document.getElementById('ot-pendientes');
            
            var draggedItem = null;
            
            // Configurar eventos de arrastre para las OT pendientes
            document.querySelectorAll('.ot-item').forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    e.dataTransfer.setData('text/plain', JSON.stringify(this.dataset));
                    this.classList.add('dragged-ot');
                });
                
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragged-ot');
                });
            });

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay,dayGridMonth'
                },
                firstDay: 1, // Lunes
                slotMinTime: "07:00:00",
                slotMaxTime: "21:00:00",
                allDaySlot: false,
                navLinks: true,
                editable: true,
                droppable: true,
                dayMaxEvents: true,
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                eventAllow: function(dropInfo, draggedEvent) { return true; },
                
                drop: function(info) {
                    if (!draggedItem) return;
                    const otData = JSON.parse(info.dataTransfer.getData('text/plain'));

                    var newEvent = {
                        id: otData.otId, // IMPORTANTE: Pasar el ID real de la OT
                        title: otData.otTitle,
                        start: info.date,
                        duration: { hours: parseInt(otData.otDuration) || 2 },
                        extendedProps: {
                            estado: otData.otEstado || 'PENDIENTE',
                            prioridad: otData.otPriority || 'MEDIA',
                            vehiculo: otData.otVehiculo || 'N/A',
                            responsable: otData.otResponsable || 'N/A',
                            tipo: 'Programada', // O el tipo real si lo tienes en dataset
                            hasAllPartsAvailable: true // Debería venir del backend
                        },
                        // Las clases se asignan vía eventClassNames
                    };
                    
                    // Llama a tu API de Django para guardar la programación
                    const csrfToken = '{{ csrf_token }}';
                    fetch(`${otUpdateDateUrl}${otData.otId}/`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                        body: JSON.stringify({ fecha_programada: info.date.toISOString() })
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Error al guardar la programación.');
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'ok') {
                            calendar.addEvent(newEvent);
                            draggedItem.remove(); // Eliminar de la lista de pendientes
                            draggedItem = null;
                            calendar.refetchEvents(); // Opcional: recargar todos los eventos para asegurar consistencia
                        } else {
                            alert('Error al programar la OT: ' + data.message);
                            draggedItem.classList.remove('dragged-ot'); // Revertir visualmente si hay error
                        }
                    })
                    .catch(error => {
                        console.error('Error al programar OT:', error);
                        alert(`Error al programar la OT: ${error.message}`);
                        draggedItem.classList.remove('dragged-ot'); // Revertir visualmente si hay error
                    });
                },
                
                dateClick: function(info) {
                    const fechaSeleccionada = info.dateStr.split('T')[0];
                    const url = `{% url 'ot_list' %}?fecha_programada=${fechaSeleccionada}&from_calendar=true`;
                    window.location.href = url;
                },
                
                // Asignar clases CSS a los eventos de FullCalendar
                eventClassNames: function(arg) {
                    let classes = []; 
                    if (arg.event.extendedProps.estado) { classes.push('estado-' + arg.event.extendedProps.estado.replace(/ /g, '_').toUpperCase()); }
                    if (arg.event.extendedProps.prioridad) { classes.push('prioridad-' + arg.event.extendedProps.prioridad.toUpperCase()); }
                    return classes;
                },

                // Carga de eventos desde Django
                events: function(fetchInfo, successCallback, failureCallback) {
                    const params = new URLSearchParams(new FormData(filtroForm)); 
                    params.append('start', fetchInfo.startStr);
                    params.append('end', fetchInfo.endStr);
                    const url = `${otEventsApiUrl}?${params.toString()}`;
                    
                    fetch(url)
                        .then(response => {
                            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                            return response.json();
                        })
                        .then(data => successCallback(data))
                        .catch(error => { console.error('Error al cargar eventos:', error); failureCallback(error); });
                },
                
                eventDrop: function(info) {
                    const otId = info.event.id;
                    const nuevaFecha = info.event.start.toISOString();
                    const csrfToken = '{{ csrf_token }}';
                    fetch(`${otUpdateDateUrl}${otId}/`, {
                        method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                        body: JSON.stringify({ fecha_programada: nuevaFecha })
                    }).catch(error => { console.error('Error al actualizar la fecha de la OT:', error); info.revert(); });
                },

                // Contenido de cada evento en el calendario
                eventContent: function(arg) {
                    let eventContentEl = document.createElement('div');
                    eventContentEl.classList.add('fc-event-main-frame'); 
                    
                    let titleEl = document.createElement('div');
                    titleEl.classList.add('fc-event-title'); // Usar la clase CSS para truncar texto
                    
                    const prioridad = arg.event.extendedProps?.prioridad;
                    let prioridadIcon = '';
                    if (prioridad === 'ALTA' || prioridad === 'CRITICA') { prioridadIcon = '<i class="fas fa-exclamation-circle"></i> '; }
                    
                    titleEl.innerHTML = prioridadIcon + arg.event.title;
                    eventContentEl.appendChild(titleEl);

                    if (arg.event.extendedProps && typeof arg.event.extendedProps.hasAllPartsAvailable !== 'undefined') {
                        let iconEl = document.createElement('i');
                        iconEl.classList.add('repuesto-icon');
                        if (arg.event.extendedProps.hasAllPartsAvailable) {
                            iconEl.classList.add('fas', 'fa-check-circle', 'text-green-300'); // Tailwind color
                            iconEl.title = 'Repuestos disponibles';
                        } else {
                            iconEl.classList.add('fas', 'fa-exclamation-triangle', 'text-amber-300'); // Tailwind color
                            iconEl.title = 'Faltan repuestos';
                        }
                        eventContentEl.appendChild(iconEl);
                    }
                    
                    return { domNodes: [eventContentEl] };
                },

                // Tooltip de Bootstrap para eventos
                eventDidMount: function(info) {
                    let repuestosStatus = 'No especificado';
                    if (info.event.extendedProps && typeof info.event.extendedProps.hasAllPartsAvailable !== 'undefined') {
                        repuestosStatus = info.event.extendedProps.hasAllPartsAvailable ? 
                            '<span class="text-green-400">Disponibles</span>' : 
                            '<span class="text-red-400">Faltan</span>';
                    }
                    const tooltipContent = `
                        <div class="p-2">
                            <div class="mb-2 border-b border-input-border pb-2">
                                <h6 class="font-bold mb-1">${info.event.title}</h6>
                                <small class="text-text-secondary">${info.event.extendedProps.tipo || 'N/A'}</small>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span class="text-text-secondary">Estado:</span>
                                <span class="font-bold">${info.event.extendedProps.estado || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span class="text-text-secondary">Vehículo:</span>
                                <span>${info.event.extendedProps.vehiculo || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span class="text-text-secondary">Responsable:</span>
                                <span>${info.event.extendedProps.responsable || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span class="text-text-secondary">Prioridad:</span>
                                <span>${info.event.extendedProps.prioridad || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-secondary">Repuestos:</span>
                                ${repuestosStatus}
                            </div>
                            <div class="text-center mt-2 pt-2 border-t border-input-border">
                                <a href="${info.event.url}" target="_blank" class="text-accent hover:underline">Ver Detalle OT</a>
                            </div>
                        </div>
                    `;

                    new bootstrap.Tooltip(info.el, {
                        html: true, placement: 'top', trigger: 'hover', container: 'body', title: tooltipContent
                    });
                },
                
                eventClick: function(info) {
                    info.jsEvent.preventDefault();
                    if (info.event.url) { window.open(info.event.url, "_blank"); }
                }
            });

            calendar.render();

            filtroForm.addEventListener('change', function() { calendar.refetchEvents(); });
            
            calendar.setOption('dropAccept', '.ot-item');
        });
    </script>
{% endblock extra_scripts %}