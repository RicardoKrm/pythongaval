<!-- templates/flota/analisis_avanzado.html (Dashboard TCO Final) -->
{% extends "flota/base.html" %}

{% block content %}
    <h1>Análisis de Costo Total de Operación (TCO)</h1>

    <div class="card">
        <h2>Filtros</h2>
        <form method="get" class="filter-form">
            <div class="form-group">
                <label for="proveedor">Proveedor:</label>
                <select name="proveedor" id="proveedor" class="form-control">
                    <option value="">Todos</option>
                    {% for p in proveedores %}<option value="{{ p.pk }}">{{ p.nombre }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="formato">Formato:</label>
                <select name="formato" id="formato" class="form-control">
                    <option value="">Todos</option>
                    {% for val, name in formatos %}<option value="{{ val }}">{{ name }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="tipo_vehiculo">Tipo Vehículo:</label>
                <select name="tipo_vehiculo" id="tipo_vehiculo" class="form-control">
                    <option value="">Todos</option>
                    {% for tv in tipos_vehiculo %}<option value="{{ tv.pk }}">{{ tv }}</option>{% endfor %}
                </select>
            </div>
            <button type="submit" class="btn-submit">Aplicar Filtros</button>
        </form>
    </div>

    <div class="card">
        <h2>Análisis de Costos</h2>
        <div class="chart-container">
            <canvas id="tcoChart"></canvas>
        </div>
    </div>
    
    <script id="tco-data" type="application/json">
    {
        "labels": {{ labels|safe }},
        "costoTotalData": {{ costo_total_data|safe }},
        "costoKmData": {{ costo_km_data|safe }},
        "kmMesData": {{ km_mes_data|safe }}
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const dataElement = document.getElementById('tco-data');
        const chartData = JSON.parse(dataElement.textContent);

        const ctx = document.getElementById('tcoChart').getContext('2d');
        new Chart(ctx, {
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        type: 'bar',
                        label: 'Costo Total ($)',
                        data: chartData.costoTotalData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        yAxisID: 'yCostoTotal',
                        order: 2
                    },
                    {
                        type: 'bar',
                        label: 'Costo por KM ($/KM)',
                        data: chartData.costoKmData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        yAxisID: 'yCostoKm',
                        barPercentage: 0.4
                    },
                    {
                        type: 'bar',
                        label: 'Promedio KM/Mes',
                        data: chartData.kmMesData,
                        backgroundColor: 'rgba(34, 197, 94, 0.7)',
                        yAxisID: 'yKm',
                        barPercentage: 0.4
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    yCostoTotal: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Costo Total ($)' } },
                    yCostoKm: { display: false }, // Ocultamos ejes extra para limpiar
                    yKm: { display: false }
                }
            }
        });
    </script>
    <style>
        .filter-form { display: flex; align-items: flex-end; gap: 20px; flex-wrap: wrap; }
        .form-group { display: flex; flex-direction: column; }
        .chart-container { position: relative; height: 500px; }
    </style>
{% endblock %}